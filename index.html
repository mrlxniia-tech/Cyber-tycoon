<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyber Tycoon V28 - Blackout</title>
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2991/2991148.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2991/2991148.png">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <style>
        :root { --neon: #00f2ff; --card: rgba(10, 10, 15, 0.98); --grad: linear-gradient(180deg, #010103 0%, #05050a 100%); }
        
        .theme-green { --neon: #00ff41 !important; } 
        .theme-red { --neon: #ff003c !important; } 
        .theme-purple { --neon: #bc13fe !important; }
        .theme-pink { --neon: #ff00ff !important; } /* Remplacement du blanc par Rose N√©on */
        
        .theme-welcome { --neon: #0077ff !important; --grad: linear-gradient(180deg, #00102a 0%, #010103 100%) !important; }
        .theme-gold { --neon: #ffcc00 !important; --grad: linear-gradient(180deg, #1a1000 0%, #010103 100%) !important; }
        .theme-summer { --neon: #ffaa00 !important; --grad: linear-gradient(180deg, #0a192f 0%, #010103 100%) !important; }
        .theme-memorial { --neon: #aaaaaa !important; --grad: linear-gradient(180deg, #1a1a1a 0%, #010103 100%) !important; }
        .theme-souvenir { --neon: #3366ff !important; --grad: linear-gradient(180deg, #050a15 0%, #010103 100%) !important; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Courier New', monospace; outline: none; }
        
        /* CACHER LES SCROLLBARS ANDROID QUI PEUVENT √äTRE BLANCHES */
        ::-webkit-scrollbar { display: none; width: 0px; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        /* ANTI-BLANC ABSOLU (V28) */
        html { overscroll-behavior: none; background-color: #000000 !important; }
        body { 
            position: fixed; inset: 0; width: 100vw; height: 100vh; 
            background-color: #010103 !important; /* FALLBACK NOIR OBLIGATOIRE */
            background-image: var(--grad); 
            color: white; margin: 0; display: flex; flex-direction: column; overflow: hidden; 
            user-select: none; transition: background-image 0.8s ease; touch-action: none; overscroll-behavior: none; 
        }
        
        #matrix { position: absolute; inset: 0; z-index: -1; opacity: 0.25; pointer-events: none; }

        header { height: 130px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; border-bottom: 2px solid var(--neon); background: var(--card); z-index: 10; box-shadow: 0 0 15px var(--neon); }
        #money { font-size: 2.5rem; font-weight: bold; color: var(--neon); text-shadow: 0 0 10px var(--neon); letter-spacing: 1px; }
        .stats-bar { display: flex; gap: 15px; font-size: 0.8rem; font-weight: bold; margin-top: 5px; }
        
        #game-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; z-index: 5; touch-action: manipulation; }
        #main-btn { width: 140px; height: 140px; border-radius: 50%; border: 4px solid var(--neon); background: rgba(0,0,0,0.6); color: var(--neon); font-size: 4rem; transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; justify-content: center; pointer-events: none; box-shadow: 0 0 25px var(--neon); line-height: 1; }
        .btn-active { transform: scale(0.85); box-shadow: 0 0 50px var(--neon) !important; }

        nav { display: flex; background: #000; height: 65px; border-top: 1px solid #333; flex-shrink: 0; z-index: 100; }
        .nav-btn { flex: 1; border: none; background: none; color: #555; font-size: 0.65rem; font-weight: bold; transition: 0.3s; }
        .nav-btn.active { color: var(--neon); border-bottom: 4px solid var(--neon); background: rgba(255,255,255,0.05); }

        .panel { flex: 1; min-height: 0; overflow-y: auto; overflow-x: hidden; padding: 15px; display: none; background: rgba(0, 0, 0, 0.5); -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; touch-action: pan-y; }
        .panel.active { display: block; }
        .content-wrapper { padding-bottom: 120px; }

        .card { background: rgba(20, 20, 25, 0.9); border: 1px solid #222; padding: 15px; margin-bottom: 15px; border-radius: 10px; border-left: 4px solid var(--neon); backdrop-filter: blur(5px); }
        .buy-btn { background: var(--neon); color: black; border: none; padding: 12px; font-weight: bold; border-radius: 6px; width: 100%; margin-top: 8px; cursor: pointer; transition: 0.2s; text-transform: uppercase; }
        .buy-btn:active { transform: scale(0.97); }
        .buy-btn:disabled { background: #222 !important; color: #555 !important; opacity: 0.5; cursor: not-allowed; transform: none; }

        #custom-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 30000; display: none; align-items: center; justify-content: center; padding: 25px; backdrop-filter: blur(3px); touch-action: none; overscroll-behavior: none; }
        #modal-box { background: #0a0a0f; border: 2px solid var(--neon); padding: 30px; border-radius: 15px; text-align: center; width: 100%; max-width: 320px; box-shadow: 0 0 30px var(--neon); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .sys-tabs { display: flex; gap: 6px; margin-bottom: 15px; }
        .s-tab { flex: 1; background: #111; border: 1px solid #333; color: #777; padding: 10px; font-size: 0.55rem; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        .s-tab.active { border-color: var(--neon); color: var(--neon); background: rgba(0,242,255,0.1); }

        #hack-ui { position: fixed; inset: 0; background: rgba(160,0,0,0.98); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; touch-action: none; overscroll-behavior: none; }
        #hack-bar { width: 85%; height: 35px; background: #000; border: 3px solid #fff; border-radius: 20px; margin: 25px; overflow: hidden; }
        #hack-fill { height: 100%; background: #00f2ff; width: 50%; transition: width 0.1s linear; box-shadow: 0 0 20px #00f2ff; }

        .floating-text { position: absolute; color: var(--neon); font-weight: bold; pointer-events: none; animation: floatUp 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards; z-index: 1000; font-size: 1.6rem; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.8); opacity: 1; } 50% { transform: translateY(-60px) scale(1.1); opacity: 1; } 100% { transform: translateY(-130px) scale(1); opacity: 0; } }
        
        .color-dot { width: 38px; height: 38px; border-radius: 50%; border: 2px solid #fff; display: inline-block; margin: 8px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .color-dot:active { transform: scale(1.2); }
        
        .online-badge { display:inline-block; width:10px; height:10px; border-radius:50%; background:#00ff41; box-shadow:0 0 8px #00ff41; margin-left:5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity:1; } 50% { opacity:0.3; } 100% { opacity:1; } }
    </style>
</head>
<body id="b-tag">
    <canvas id="matrix"></canvas>

    <div id="custom-modal" onclick="if(event.target === this) closeModal()">
        <div id="modal-box">
            <h2 id="modal-title" style="color:var(--neon); margin-top:0; font-size: 1.2rem;">SYSTEM_INFO</h2>
            <p id="modal-msg" style="font-size:0.9rem; line-height:1.5; margin-bottom: 20px;"></p>
            <button class="buy-btn" onclick="closeModal()">FERMER</button>
        </div>
    </div>

    <div id="hack-ui">
        <h1 style="color:white; text-shadow: 0 0 15px red; margin:0; font-size:2.5rem;">‚ö†Ô∏è INTRUSION ‚ö†Ô∏è</h1>
        <p style="color:white; font-size: 0.9rem; margin-top: 10px; font-weight:bold;">Siphonage r√©seau en cours...</p>
        <div id="hack-bar"><div id="hack-fill"></div></div>
        <button onclick="hackTap()" style="width:170px; height:170px; border-radius:50%; background:white; color:red; font-weight:bold; border:8px solid #000; font-size:1.8rem; box-shadow: 0 0 40px #fff; transition:0.1s;">BLOQUER</button>
    </div>

    <header>
        <div id="money">0 ‚Ç¨</div>
        <div class="stats-bar">
            <span id="ips-display" style="color:#00ff41;">+0 ‚Ç¨/s</span>
            <span id="click-val" style="color:var(--neon);">Clic: 1‚Ç¨</span>
        </div>
        <div style="font-size:0.65rem; color:#666; margin-top:10px;">UID: <span id="h-name">---</span> | PRESTIGE: <span id="rb-val">0</span></div>
    </header>

    <div id="game-area" onmousedown="tap(event)" ontouchstart="tap(event)">
        <div id="main-btn">$</div>
    </div>

    <nav>
        <button class="nav-btn active" onclick="tab(event, 'shop')">SHOP</button>
        <button class="nav-btn" onclick="tab(event, 'quest')">MISSIONS</button>
        <button class="nav-btn" onclick="tab(event, 'rank')">R√âSEAU <div class="online-badge"></div></button>
        <button class="nav-btn" onclick="tab(event, 'config')">SYSTEM</button>
    </nav>

    <div id="shop" class="panel active">
        <div class="content-wrapper">
            <div class="sys-tabs">
                <button class="s-tab active" onclick="setBuyM(1, this)">x1</button>
                <button class="s-tab" onclick="setBuyM(5, this)">x5</button>
                <button class="s-tab" onclick="setBuyM(10, this)">x10</button>
                <button class="s-tab" onclick="setBuyM(100, this)">MAX</button>
            </div>
            <div id="shop-list"></div>
        </div>
    </div>

    <div id="quest" class="panel"><div class="content-wrapper" id="quest-list"></div></div>
    
    <div id="rank" class="panel">
        <div class="content-wrapper">
            <p style="text-align:center; font-size:0.8rem; margin-top:0; color:var(--neon);">üåê SERVEUR MONDIAL CONNECT√â</p>
            <div id="rank-list">Chargement des donn√©es...</div>
        </div>
    </div>

    <div id="config" class="panel">
        <div class="content-wrapper">
            <div class="sys-tabs">
                <button class="s-tab active" onclick="subTab('sys-prof', this)">PROFIL</button>
                <button class="s-tab" onclick="subTab('sys-param', this)">PARAM</button>
                <button class="s-tab" onclick="subTab('sys-stats', this)">STATS</button>
                <button id="admin-tab-btn" class="s-tab" onclick="subTab('sys-admin', this)" style="display:none; color:#ff00ff; border-color:#ff00ff;">ADMIN</button>
            </div>

            <div id="sys-prof" class="sub-panel">
                <div class="card">
                    <p style="font-size:0.8rem; margin-bottom:10px;">HACKER_IDENTITY</p>
                    <input type="text" id="name-change" placeholder="Modifier Pseudo" maxlength="12" style="width:100%; background:#000; color:white; border:1px solid #333; padding:12px; margin-bottom:10px; text-align: center; font-weight:bold;">
                    <button class="buy-btn" onclick="changeName()">SYNC PSEUDO</button>
                    <p style="font-size:0.8rem; margin:20px 0 10px 0;">UI_COLOR_SCHEME</p>
                    <div style="text-align:center;">
                        <div class="color-dot" style="background:#00f2ff" onclick="setTh('')"></div>
                        <div class="color-dot" style="background:#00ff41" onclick="setTh('theme-green')"></div>
                        <div class="color-dot" style="background:#ff003c" onclick="setTh('theme-red')"></div>
                        <div class="color-dot" style="background:#bc13fe" onclick="setTh('theme-purple')"></div>
                        <div class="color-dot" style="background:#ff00ff" onclick="setTh('theme-pink')"></div>
                    </div>
                </div>
                <button class="buy-btn" id="rb-btn" onclick="doRebirth()" disabled>PRESTIGE (<span id="rb-cost">1.00</span>M ‚Ç¨)</button>
            </div>

            <div id="sys-param" class="sub-panel" style="display:none;">
                <div class="card">
                    <p style="font-size:0.8rem; margin-bottom:10px;">SOCIAL_NETWORK</p>
                    <input type="text" id="friend-id-in" placeholder="Coller ID Base64" style="width:100%; background:#000; color:white; border:1px solid var(--neon); padding:10px; margin-bottom:10px; text-align: center;">
                    <button class="buy-btn" onclick="addFriend()">REJOINDRE L'AMI</button>
                    <button class="buy-btn" onclick="copyMyId()" style="background:#333; color:white; margin-top:10px;">MON ID CLOUD</button>
                </div>
                <div class="card">
                    <button class="buy-btn" onclick="toggleSound()" id="sound-btn">SOUND : ON</button>
                    <button class="buy-btn" onclick="window.location.href='mailto:Mrlxniia@gmail.com'" style="background:#222; color:var(--neon); border:1px solid var(--neon); margin-top:10px;">CONTACT SUPPORT</button>
                </div>
                <button onclick="resetGame()" style="width:100%; background:none; border:1px solid red; color:red; padding:15px; font-size:0.7rem; font-weight:bold; margin-top:20px; border-radius: 8px;">FORMATER LE SYSTEME</button>
            </div>

            <div id="sys-stats" class="sub-panel" style="display:none;">
                <div class="card">
                    <p>Clics Totaux : <span id="st-clicks" style="color:var(--neon);">0</span></p>
                    <p>D√©fenses R√©ussies : <span id="st-win" style="color:#00ff41;">0</span></p>
                    <p>D√©fenses √âchou√©es : <span id="st-loss" style="color:#ff003c;">0</span></p>
                    <p>Rebirths effectu√©s : <span id="st-rb" style="color:var(--neon);">0</span></p>
                    <p>Argent Cumul√© : <span id="st-total" style="color:var(--neon);">0</span> ‚Ç¨</p>
                </div>
            </div>

            <div id="sys-admin" class="sub-panel" style="display:none;">
                <div class="card" style="border-color:#ff00ff; background:rgba(255,0,255,0.05);">
                    <p style="color:#ff00ff; font-weight:bold; font-size: 0.9rem; margin-bottom: 10px; text-align:center;">MRLX_ROOT_ACCESS</p>
                    <button class="buy-btn" style="background:#ff00ff; color:white;" onclick="startHackFight()">FORCER HACK</button>
                    <button class="buy-btn" style="background:#ff00ff; color:white; margin-top:5px;" onclick="g.m += 1000000000; render();">+1B ‚Ç¨ (Milliard)</button>
                    <p style="font-size:0.6rem; color:#ff00ff; margin-top:15px; text-align:center;">FORCER THEME :</p>
                    <button class="buy-btn" onclick="forceEvent('easter')" style="border:1px solid #ff00ff; background:#111; color:white;">P√ÇQUES (x8)</button>
                    <button class="buy-btn" onclick="forceEvent('summer')" style="border:1px solid #ff00ff; background:#111; color:white;">√âT√â (x1.5)</button>
                    <button class="buy-btn" onclick="forceEvent('memorial')" style="border:1px solid #ff00ff; background:#111; color:white;">9/11 (GRIS)</button>
                    <button class="buy-btn" onclick="forceEvent('souvenir')" style="border:1px solid #ff00ff; background:#111; color:white;">11/11 (BLEU)</button>
                    <button class="buy-btn" onclick="location.reload()" style="background:#000; color:#ff00ff; margin-top:15px;">DESACTIVER ADMIN</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.body.addEventListener('touchmove', function(e) {
            if (!e.target.closest('.panel')) { e.preventDefault(); }
        }, { passive: false });

        const firebaseConfig = {
            apiKey: "AIzaSyDw1J_Vy4aRNuFV6M_SZbADr2TTlz0zots",
            authDomain: "shadowlink-be54d.firebaseapp.com",
            databaseURL: "https://shadowlink-be54d-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "shadowlink-be54d",
            storageBucket: "shadowlink-be54d.firebasestorage.app",
            messagingSenderId: "1030800890289",
            appId: "1:1030800890289:web:ef5c2f28a342c54e524590"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let globalRank = [];

        let g = { uid: null, m: 0, n: "Hacker", items: [0,0,0,0,0,0,0,0], rb: 0, th: "", firstLogin: Date.now(), lastHack: Date.now(), lastSave: Date.now(), s_click: 0, s_win: 0, s_loss: 0, s_total: 0, sound: true, friends: [], q: [false,false,false,false,false,false] };
        let buyM = 1; let AC; let hackPower = 50; let hackInterval; let dateMult = 1; let forcedEv = null; let rAF_ID; let lastTick = Date.now(); let tickCount = 0;

        const items = [
            {n:"Overclock",c:50,p:2,cl:true}, {n:"Bot Script",c:40,p:1}, {n:"Proxy Tunnel",c:300,p:15},
            {n:"Mining Rig",c:3000,p:90}, {n:"Mainframe",c:40000,p:800}, {n:"Neural Grid",c:200000,p:4500},
            {n:"Quantum PC",c:1500000,p:25000}, {n:"Satellite Ops",c:25000000,p:150000}
        ];

        function syncData() {
            if(!g.uid) return;
            db.ref('leaderboard/' + g.uid).set({ n: g.n, rb: g.rb, m: g.m, timestamp: Date.now() });
        }

        db.ref('leaderboard').limitToLast(100).on('value', (snap) => {
            let data = snap.val();
            let arr = [];
            for(let key in data) { arr.push({uid: key, ...data[key]}); }
            globalRank = arr;
            render();
        });

        function forceSync() { syncData(); openModal("CLOUD", "Donn√©es synchronis√©es avec succ√®s !"); }

        function formatNum(num) {
            if (num < 1000) return Math.floor(num);
            let suffixes = ["", "k", "M", "B", "T", "Qa", "Qi"];
            let suffixNum = Math.floor(("" + Math.floor(num)).length / 3);
            if(suffixNum >= suffixes.length) suffixNum = suffixes.length - 1;
            let shortValue = parseFloat((suffixNum !== 0 ? (num / Math.pow(1000, suffixNum)) : num).toPrecision(3));
            if (shortValue % 1 !== 0) shortValue = shortValue.toFixed(2);
            return shortValue + suffixes[suffixNum];
        }

        function openModal(title, msg) { document.getElementById('modal-title').innerText = title; document.getElementById('modal-msg').innerText = msg; document.getElementById('custom-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }

        function playSfx(f, type='square', vol=0.03, dur=0.1) {
            if(!g.sound) return;
            try { if(!AC) AC = new AudioContext(); let o=AC.createOscillator(), gn=AC.createGain(); o.type=type; o.frequency.value=f; gn.gain.setValueAtTime(vol, AC.currentTime); gn.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime+dur); o.connect(gn); gn.connect(AC.destination); o.start(); o.stop(AC.currentTime+dur); } catch(e){}
        }

        function playAlarm() {
            let i = 0;
            let alarm = setInterval(() => {
                if(document.getElementById('hack-ui').style.display === 'none') { clearInterval(alarm); return; }
                playSfx(i % 2 === 0 ? 800 : 500, 'sawtooth', 0.05, 0.4);
                i++;
            }, 500);
        }

        function checkDates() {
            if(forcedEv) return;
            const now = new Date(), m = now.getMonth(), d = now.getDate(), b = document.getElementById('b-tag'), btn = document.getElementById('main-btn');
            let ev = false; dateMult = 1;
            let isWelcome = (Date.now() - g.firstLogin < 900000); 

            b.className = "";

            if (m === 3 && d >= 18 && d <= 20) { b.className = "theme-gold"; btn.innerText = "ü•ö"; dateMult = 8; ev = true; }
            else if (m >= 5 && m <= 7) { b.className = "theme-summer"; btn.innerText = "‚òÄÔ∏è"; dateMult = 1.5; ev = true; }
            else if (m === 8 && d === 11) { b.className = "theme-memorial"; btn.innerText = "üïäÔ∏è"; ev = true; }
            else if (m === 10 && d === 11) { b.className = "theme-souvenir"; btn.innerText = "üïØÔ∏è"; ev = true; }
            
            if(!ev) { 
                btn.innerText = "$";
                if (g.th) { b.className = g.th; } 
                else if (isWelcome) { b.className = "theme-welcome"; }
            }
            if (isWelcome && !ev) dateMult = 2; 
            checkAdmin();
        }

        function forceEvent(type) {
            forcedEv = type; const b = document.getElementById('b-tag'), btn = document.getElementById('main-btn');
            b.className = "theme-" + (type === 'easter' ? 'gold' : type);
            if(type === 'easter') { btn.innerText = "ü•ö"; dateMult = 8; }
            else if(type === 'summer') { btn.innerText = "‚òÄÔ∏è"; dateMult = 1.5; }
            else if(type === 'memorial') { btn.innerText = "üïäÔ∏è"; }
            else if(type === 'souvenir') { btn.innerText = "üïØÔ∏è"; }
            render();
        }

        function checkAdmin() { 
            let btn = document.getElementById('admin-tab-btn');
            if(g.n.toLowerCase() === "mrlx") { btn.style.display = "block"; } else { btn.style.display = "none"; }
        }

        window.onload = () => {
            let s = localStorage.getItem('CT_V28_BLACKOUT');
            if(s) {
                try { g = JSON.parse(decodeURIComponent(atob(s))); } catch(e) { try { g = JSON.parse(s); } catch(e2) {} }
            }
            if(!g.uid) { g.uid = 'user_' + Math.random().toString(36).substr(2, 9); }
            
            let idle = Math.floor((Date.now() - g.lastSave) / 1000);
            if(idle > 10) {
                let ips=0; g.items.forEach((q,i)=>{if(i>0)ips+=q*items[i].p;});
                let gain = ips * Math.max(1, g.rb*2) * idle;
                if(gain > 0) { g.m += gain; g.s_total += gain; setTimeout(()=>openModal("REPORT_OFFLINE", `Tes bots ont g√©n√©r√© ${formatNum(gain)} ‚Ç¨ en ton absence.`), 600); }
            }
            
            checkDates(); render(); startMatrix(); 
            requestAnimationFrame(gameLoop);
            syncData(); 
        };

        function save() { 
            g.lastSave = Date.now(); 
            localStorage.setItem('CT_V28_BLACKOUT', btoa(encodeURIComponent(JSON.stringify(g)))); 
        }

        function gameLoop() {
            let now = Date.now(); let dt = now - lastTick;
            if (dt >= 1000) { 
                let ips=0; g.items.forEach((q,i)=>{if(i>0)ips+=q*items[i].p;});
                let profit = ips * Math.max(1, g.rb*2);
                g.m += profit; g.s_total += profit;
                
                if(Date.now() - g.lastHack > 28800000) startHackFight();
                if(!forcedEv) checkDates(); 
                
                tickCount++; if(tickCount % 30 === 0) syncData();

                save(); render();
                lastTick = now - (dt % 1000); 
            }
            rAF_ID = requestAnimationFrame(gameLoop);
        }

        function tap(e) {
            e.preventDefault();
            let val = (1 + (g.items[0]*4*dateMult)) * (Math.max(1, g.rb*2));
            g.m += val; g.s_total += val; g.s_click++;
            
            const btn = document.getElementById('main-btn'); btn.classList.add('btn-active'); setTimeout(()=>btn.classList.remove('btn-active'), 100);
            
            let d = document.createElement('div'); d.className='floating-text';
            let x = e.clientX || (e.touches ? e.touches[0].clientX : window.innerWidth/2);
            let y = e.clientY || (e.touches ? e.touches[0].clientY : window.innerHeight/2);
            let angle = Math.floor(Math.random() * 30) - 15; 
            d.style.left = (x - 20) + 'px'; d.style.top = (y - 20) + 'px'; d.style.transform = `rotate(${angle}deg)`;
            d.innerText = "+" + formatNum(val) + (forcedEv==='easter'?'ü•ö':'‚Ç¨');
            
            document.body.appendChild(d); setTimeout(()=>d.remove(), 800);
            playSfx(400 + Math.random()*50); render();
        }

        function render() {
            let multi = Math.max(1, g.rb*2); let rbCost = 1000000 * Math.pow(5, g.rb);
            
            document.getElementById('money').innerText = formatNum(g.m) + " ‚Ç¨";
            let ips=0; g.items.forEach((q,i)=>{if(i>0)ips+=q*items[i].p;});
            document.getElementById('ips-display').innerText = "+" + formatNum(ips*multi) + " ‚Ç¨/s";
            document.getElementById('click-val').innerText = "Clic: " + formatNum((1+(g.items[0]*4*dateMult))*multi) + "‚Ç¨";
            document.getElementById('h-name').innerText = g.n; 
            document.getElementById('rb-val').innerText = g.rb;
            
            document.getElementById('rb-cost').innerText = formatNum(rbCost);
            document.getElementById('rb-btn').disabled = (g.m < rbCost);
            document.getElementById('st-clicks').innerText = formatNum(g.s_click);
            document.getElementById('st-win').innerText = g.s_win;
            document.getElementById('st-loss').innerText = g.s_loss;
            document.getElementById('st-total').innerText = formatNum(g.s_total);
            document.getElementById('st-rb').innerText = g.rb;

            let sh = ""; items.forEach((it, i) => {
                let cost = 0; let realBuyM = (buyM === 100) ? 100 : buyM; 
                for(let n=0; n<realBuyM; n++) cost += Math.floor(it.c * Math.pow(1.5, g.items[i]+n));
                sh += `<div class="card"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><b style="font-size:1.1rem;">${it.n}</b> <span style="font-size:1.1rem; color:var(--neon);">x${g.items[i]}</span></div><div style="font-size:0.7rem; color:#888;">Yield: ${it.cl?'+Clics':'+'+formatNum(it.p)+'‚Ç¨/s'}</div><button class="buy-btn" ${g.m < cost ? 'disabled' : ''} onclick="buy(${i})">ACHETER ${realBuyM} (${formatNum(cost)} ‚Ç¨)</button></div>`;
            });
            document.getElementById('shop-list').innerHTML = sh;

            let qh = ""; const quests = [
                {n:"Noob Hacker", t:10000, v:g.m}, {n:"Hacker Pro", t:1000000, v:g.m}, {n:"Deep Web", t:100000000, v:g.m},
                {n:"Overclocker", t:30, v:g.items[0]}, {n:"Miner Rig", t:15, v:g.items[3]}, {n:"Satellite Ops", t:5, v:g.items[7]}
            ];
            quests.forEach((q,i)=>{
                if(q.v >= q.t && !g.q[i]) { g.q[i]=true; g.m += q.t*0.2; playSfx(1000); openModal("QUEST_COMPLETE", `Mission accomplie ! R√©compense: +${formatNum(q.t*0.2)}‚Ç¨`); }
                let prg = Math.min(100, (q.v/q.t)*100);
                qh += `<div class="card" style="opacity:${g.q[i]?0.4:1}"><div style="display:flex; justify-content:space-between;"><b>${q.n}</b> <span style="font-size:0.8rem;">${formatNum(q.v)} / ${formatNum(q.t)}</span></div><div style="width:100%; height:8px; background:#111; margin-top:10px; border-radius:10px; overflow:hidden;"><div style="width:${prg}%; height:100%; background:var(--neon); box-shadow: 0 0 10px var(--neon);"></div></div></div>`;
            });
            document.getElementById('quest-list').innerHTML = qh;

            let lbd = [...globalRank];
            lbd.push({n:"Satoshi [BOSS]", rb:99, m:9e12, boss:true});
            if(!lbd.find(x => x.uid === g.uid)) { lbd.push({uid: g.uid, n: g.n, rb: g.rb, m: g.m}); }
            lbd.sort((a,b) => b.rb - a.rb || b.m - a.m);
            
            document.getElementById('rank-list').innerHTML = lbd.map((r,i)=>{
                let isMe = r.uid === g.uid;
                let color = r.boss ? '#ffcc00' : (isMe ? 'var(--neon)' : '#fff');
                return `<div class="card" style="border-color:${color}; ${isMe?'background:rgba(0,242,255,0.05)':''}"><b style="color:${color};">#${i+1}</b> ${r.n} [RB:${r.rb}] <br><span style="font-size:0.8rem; color:#888;">${formatNum(r.m)} ‚Ç¨</span></div>`;
            }).join('');
        }

        function startHackFight() { hackPower=50; document.getElementById('hack-ui').style.display='flex'; playAlarm(); let speed = Math.random() * 3.5 + 0.5; hackInterval=setInterval(()=>{ hackPower-=speed; document.getElementById('hack-fill').style.width=hackPower+"%"; if(hackPower<=0) endHack(false); },100); }
        function hackTap() { hackPower+=6; playSfx(200); document.getElementById('hack-fill').style.width=hackPower+"%"; if(hackPower>=100) endHack(true); }
        function endHack(win) { clearInterval(hackInterval); document.getElementById('hack-ui').style.display='none'; g.lastHack=Date.now(); if(win){ g.m*=1.2; g.s_win++; openModal("DEFENSE_OK", "Syst√®me s√©curis√©. Tu as vol√© 20% des fonds du Hacker !"); } else { g.m*=0.8; g.s_loss++; openModal("DEFENSE_FAIL", "Br√®che d√©tect√©e. Tu as perdu 20% de ton argent."); } syncData(); save(); render(); }
        function buy(i) { let cost=0; let realBuyM = (buyM === 100) ? 100 : buyM; for(let n=0; n<realBuyM; n++) cost+=Math.floor(items[i].c*Math.pow(1.5,g.items[i]+n)); if(g.m>=cost){ g.m-=cost; g.items[i]+=realBuyM; playSfx(600); render(); save(); } }
        function tab(e, id) { document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); e.currentTarget.classList.add('active'); }
        function subTab(id, btn) { document.querySelectorAll('.sub-panel').forEach(p=>p.style.display='none'); document.querySelectorAll('.s-tab').forEach(b=>b.classList.remove('active')); document.getElementById(id).style.display='block'; btn.classList.add('active'); }
        
        function changeName() { 
            let newName = document.getElementById('name-change').value.trim(); 
            if(newName.length < 2) { openModal("ERREUR", "Le pseudo doit contenir au moins 2 caract√®res."); return; }
            let reservedNames = ["satoshi", "satoshi [boss]", "mitnick", "anonymous", "skynet"];
            if(reservedNames.includes(newName.toLowerCase())) { openModal("ACC√àS REFUS√â", "Ce pseudo est r√©serv√© aux serveurs du syst√®me."); return; }
            db.ref('leaderboard').once('value').then((snapshot) => {
                let nameTaken = false;
                snapshot.forEach((childSnapshot) => {
                    let player = childSnapshot.val();
                    if (player.n && player.n.toLowerCase() === newName.toLowerCase() && childSnapshot.key !== g.uid) { nameTaken = true; }
                });
                if (nameTaken) { openModal("ERREUR", "Ce pseudo est d√©j√† utilis√© par un autre joueur dans le monde.");
                } else { g.n = newName; checkAdmin(); syncData(); render(); save(); openModal("INFO", "Identit√© cloud mise √† jour avec succ√®s !"); document.getElementById('name-change').value = ''; }
            }).catch((error) => { openModal("ERREUR R√âSEAU", "Impossible de v√©rifier le pseudo. V√©rifie ta connexion."); });
        }
        
        function setTh(t) { g.th=t; checkDates(); save(); }
        function toggleSound() { g.sound=!g.sound; document.getElementById('sound-btn').innerText="SOUND : "+(g.sound?"ON":"OFF"); }
        function setBuyM(m,b) { buyM=m; document.querySelectorAll('.sys-tabs .s-tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); render(); }
        function copyMyId() { navigator.clipboard.writeText(btoa(encodeURIComponent(g.n+"|"+g.rb+"|"+Math.floor(g.m)))); openModal("ID_CLOUD", "Ton ID unique a √©t√© copi√© !"); }
        function addFriend() { try { let d=decodeURIComponent(atob(document.getElementById('friend-id-in').value)).split('|'); g.friends.push({n:d[0], rb:parseInt(d[1]), m:parseInt(d[2])}); render(); save(); openModal("INFO","Ami ajout√© au r√©seau !"); } catch(e){openModal("ERROR","Format ID Invalide.");} }
        function doRebirth() { let c=1000000*Math.pow(5,g.rb); if(g.m>=c){ g.m=0; g.items=g.items.map(()=>0); g.q=g.q.map(()=>false); g.rb++; syncData(); save(); location.reload(); } }
        function resetGame() { if(confirm("EFFACER COMPTE CLOUD ?")){ localStorage.clear(); db.ref('leaderboard/' + g.uid).remove(); location.reload(); } }
        function startMatrix() { const c=document.getElementById('matrix'), ctx=c.getContext('2d'); c.width=window.innerWidth; c.height=window.innerHeight; const drops=Array(Math.floor(c.width/15)).fill(1); setInterval(()=>{ ctx.fillStyle="rgba(0,0,0,0.05)"; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--neon'); ctx.font = "15px monospace"; drops.forEach((y,i)=>{ ctx.fillText(Math.floor(Math.random()*2), i*15, y*15); if(y*15>c.height && Math.random()>0.98) drops[i]=0; drops[i]++; }); }, 50); }
    </script>
</body>
</html>
